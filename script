import json
from decimal import Decimal
from datetime import datetime
import pytz
import os

# Fun√ß√µes auxiliares
def carregar_json(nome_arquivo, default):
    if os.path.exists(nome_arquivo):
        with open(nome_arquivo, "r") as f:
            try:
                return json.load(f)
            except json.JSONDecodeError:
                print(f"Arquivo corrompido: {nome_arquivo}")
    return default

def salvar_json(nome_arquivo, dados):
    with open(nome_arquivo, "w") as f:
        json.dump(dados, f, indent=4)

# Obter data/hora com fuso
def obter_data_hora(cidade):
    fuso_map = {
        "S√£o Paulo": "America/Sao_Paulo",
        "Rio de Janeiro": "America/Sao_Paulo",
        "Manaus": "America/Manaus",
        "Recife": "America/Recife",
        "Porto Alegre": "America/Sao_Paulo" # Assuming same timezone as SP
    }
    # Get timezone from map, default to S√£o Paulo if city not found
    fuso = pytz.timezone(fuso_map.get(cidade, "America/Sao_Paulo"))
    return datetime.now(fuso).strftime("%d/%m/%Y %H:%M:%S")

# Cadastro de cliente
def cadastrar_cliente():
    print("\n--- üìù Cadastro de Novo Cliente ---")
    print("Por favor, insira seus dados para criar uma nova conta.")
    cpf = input("‚û°Ô∏è CPF (somente n√∫meros): ").strip()
    nome = input("‚û°Ô∏è Nome completo: ").strip()
    logradouro = input("‚û°Ô∏è Logradouro (rua, n√∫mero, bairro): ").strip()
    cidade = input("‚û°Ô∏è Cidade: ").strip()

    clientes = carregar_json("clientes.json", {})
    if cpf in clientes:
        print("‚ùå Erro: Cliente com este CPF j√° est√° cadastrado em nosso sistema. Tente autenticar (Op√ß√£o 2).")
        return

    clientes[cpf] = {
        "nome": nome,
        "logradouro": logradouro,
        "cidade": cidade
    }
    salvar_json("clientes.json", clientes)
    print("‚úÖ Sucesso: Cliente cadastrado com sucesso! Agora voc√™ pode autenticar para acessar sua conta.")

# Autentica√ß√£o de cliente
def autenticar_cliente():
    """Autentica um cliente existente."""
    print("\n--- üîë Autentica√ß√£o de Cliente ---")
    print("Por favor, digite seu CPF para acessar sua conta.")
    cpf = input("‚û°Ô∏è CPF: ").strip()
    clientes = carregar_json("clientes.json", {})
    if cpf in clientes:
        print(f"üëã Bem-vindo(a) de volta, {clientes[cpf]['nome']}! Autentica√ß√£o bem-sucedida.")
        return cpf
    else:
        print("‚ùå Erro: Cliente n√£o encontrado. Verifique o CPF digitado ou cadastre-se (Op√ß√£o 1).")
        return None

# Cadastro de conta banc√°ria
def cadastrar_conta(cpf):
    """Cria uma nova conta banc√°ria com um n√∫mero √∫nico e sequencial para o cliente autenticado."""
    print("\n--- üí≥ Cadastro de Conta Banc√°ria ---")
    print("Estamos criando uma nova conta para voc√™.")
    contas = carregar_json("contas.json", {})
    clientes = carregar_json("clientes.json", {})

    # Generate a unique, sequential account number
    last_account_number = "0000-00"
    for acc_num in contas.keys():
         if "-" in acc_num:
              try:
                  num_part = int(acc_num.split('-')[0])
                  last_num_part = int(last_account_number.split('-')[0])
                  if num_part > last_num_part:
                      last_account_number = acc_num
                  elif num_part == last_num_part:
                      digit_part = int(acc_num.split('-')[1])
                      last_digit_part = int(last_account_number.split('-')[1])
                      if digit_part > last_digit_part:
                           last_account_number = acc_num
              except ValueError:
                  pass

    # Increment the last account number
    try:
        num_part, digit_part = map(int, last_account_number.split('-'))
        if digit_part < 99:
            digit_part += 1
        else:
            num_part += 1
            digit_part = 1
        novo_numero_conta = f"{num_part:04d}-{digit_part:02d}"
    except ValueError:
        novo_numero_conta = "0001-01"

    # Ensure the generated number is actually unique
    while novo_numero_conta in contas:
         print(f"‚ö†Ô∏è Aten√ß√£o: N√∫mero de conta {novo_numero_conta} j√° existe. Gerando pr√≥ximo n√∫mero...")
         try:
              num_part, digit_part = map(int, novo_numero_conta.split('-'))
              if digit_part < 99:
                  digit_part += 1
              else:
                  num_part += 1
                  digit_part = 1
              novo_numero_conta = f"{num_part:04d}-{digit_part:02d}"
         except ValueError:
              print("‚ùå Erro ao gerar novo n√∫mero de conta. Saindo do cadastro.")
              return


    # Create the new account entry
    contas[novo_numero_conta] = {
        "cpf": cpf,
        "saldo": str(Decimal(0)),
        "extrato": [],
        "saques_hoje": "0",
        "last_saque_date": None # Placeholder for future daily limit reset
    }

    salvar_json("contas.json", contas)
    print(f"‚úÖ Sucesso: Conta banc√°ria criada com sucesso! Seu novo n√∫mero de conta √©: ‚ú® {novo_numero_conta} ‚ú®.")
    print("Agora voc√™ pode acessar esta conta para realizar opera√ß√µes, como Dep√≥sitos e Saques.")

# Selecionar conta existente
def selecionar_conta(cpf):
    """Permite que o cliente autenticado selecione uma de suas contas existentes."""
    print("\n--- üîë Acessar Conta Existente ---")
    contas = carregar_json("contas.json", {})

    contas_do_cliente = {}
    for conta_numero, dados_conta in contas.items():
        if dados_conta.get("cpf") == cpf:
            contas_do_cliente[conta_numero] = dados_conta

    if not contas_do_cliente:
        print("‚ö†Ô∏è Aten√ß√£o: Voc√™ n√£o possui nenhuma conta banc√°ria associada a este CPF. Por favor, cadastre uma conta primeiro (Op√ß√£o 1 no menu de contas).")
        return None

    print("Suas contas dispon√≠veis:")
    contas_list = sorted(contas_do_cliente.keys())
    for i, conta_num in enumerate(contas_list):
        saldo = Decimal(contas_do_cliente[conta_num].get("saldo", "0"))
        print(f"{i + 1}. Conta: {conta_num} (Saldo: R$ {saldo:.2f})")

    while True:
        escolha_str = input("‚û°Ô∏è Digite o N√öMERO CORRESPONDENTE da conta que deseja acessar: ").strip()
        try:
            escolha_index = int(escolha_str) - 1
            if 0 <= escolha_index < len(contas_list):
                conta_selecionada = contas_list[escolha_index]
                print(f"‚úÖ Conta {conta_selecionada} selecionada com sucesso! Voc√™ pode come√ßar a operar.")
                return conta_selecionada
            else:
                print("‚ùå Erro: N√∫mero de conta inv√°lido. Por favor, escolha um n√∫mero da lista acima.")
        except ValueError:
            print("‚ùå Erro: Entrada inv√°lida. Por favor, digite o n√∫mero correspondente √† conta.")

# Realizar dep√≥sito
def depositar(conta_numero):
    """Permite que um cliente autenticado realize dep√≥sitos em sua conta."""
    print("\n--- üí∞ Realizar Dep√≥sito ---")
    contas = carregar_json("contas.json", {})
    clientes = carregar_json("clientes.json", {})

    if conta_numero not in contas:
        print("‚ö†Ô∏è Aten√ß√£o: A conta banc√°ria selecionada n√£o foi encontrada.")
        return

    conta = contas[conta_numero]
    cpf = conta.get("cpf")

    if not cpf or cpf not in clientes:
         print("‚ùå Erro: Informa√ß√µes do cliente associado √† conta n√£o encontradas.")
         return

    saldo_decimal = Decimal(conta["saldo"])

    while True:
        valor_str = input("‚û°Ô∏è Digite o valor que deseja depositar (somente n√∫meros, use '.' para centavos, ex: 100.50): R$ ").strip().replace(",", ".")
        try:
            valor = Decimal(valor_str)
            if valor <= 0:
                print("‚ùå Erro: O valor do dep√≥sito deve ser positivo. Por favor, tente novamente.")
            else:
                break
        except:
            print("‚ùå Erro: Valor inv√°lido. Por favor, digite um n√∫mero v√°lido para o dep√≥sito.")

    novo_saldo = saldo_decimal + valor
    conta["saldo"] = str(novo_saldo)

    cidade_cliente = clientes.get(cpf, {}).get("cidade", "S√£o Paulo")
    data_hora = obter_data_hora(cidade_cliente)

    conta["extrato"].append({"tipo": "Dep√≥sito", "valor": str(valor), "data_hora": data_hora})

    salvar_json("contas.json", contas)
    print(f"‚úÖ Sucesso: Dep√≥sito de R$ {valor:.2f} realizado com sucesso na conta {conta_numero}!")
    print(f"‚ú® Seu novo saldo √© de R$ {novo_saldo:.2f}.")

# Realizar saque
def sacar(conta_numero):
    """Permite que um cliente autenticado realize saques de sua conta."""
    print("\n--- üí∏ Realizar Saque ---")
    contas = carregar_json("contas.json", {})
    clientes = carregar_json("clientes.json", {})
    limite_saque_diario = Decimal("500.00")

    if conta_numero not in contas:
        print("‚ö†Ô∏è Aten√ß√£o: A conta banc√°ria selecionada n√£o foi encontrada.")
        return

    conta = contas[conta_numero]
    cpf = conta.get("cpf")

    if not cpf or cpf not in clientes:
         print("‚ùå Erro: Informa√ß√µes do cliente associado √† conta n√£o encontradas.")
         return

    saldo_decimal = Decimal(conta["saldo"])
    saques_hoje = Decimal(conta.get("saques_hoje", "0"))

    # Basic daily reset (can be improved with date tracking)
    # For this task, we'll just check the accumulated amount for today.
    # A more robust solution would require storing the date of the last withdrawal.

    print(f"‚ÑπÔ∏è Seu saldo atual √© de R$ {saldo_decimal:.2f}.")
    print(f"‚ÑπÔ∏è Limite de saque di√°rio: R$ {limite_saque_diario:.2f}. Voc√™ j√° sacou R$ {saques_hoje:.2f} hoje.")
    limite_restante = limite_saque_diario - saques_hoje
    print(f"‚ÑπÔ∏è Limite restante para saque hoje: R$ {limite_restante:.2f}.")


    while True:
        valor_str = input(f"‚û°Ô∏è Digite o valor que deseja sacar (somente n√∫meros, use '.' para centavos, at√© R$ {limite_restante:.2f}): R$ ").strip().replace(",", ".")
        try:
            valor = Decimal(valor_str)
            if valor <= 0:
                print("‚ùå Erro: O valor do saque deve ser positivo. Por favor, tente novamente.")
            else:
                break
        except:
            print("‚ùå Erro: Valor inv√°lido. Por favor, digite um n√∫mero v√°lido para o saque.")

    if valor > saldo_decimal:
        print("‚ùå Erro: Saldo insuficiente. Voc√™ n√£o possui fundos suficientes para realizar este saque.")
        return

    if valor > limite_restante:
         print(f"‚ùå Erro: Valor excede o limite de saque di√°rio restante. Voc√™ pode sacar no m√°ximo R$ {limite_restante:.2f} hoje.")
         return

    novo_saldo = saldo_decimal - valor
    conta["saldo"] = str(novo_saldo)

    conta["saques_hoje"] = str(saques_hoje + valor)

    cidade_cliente = clientes.get(cpf, {}).get("cidade", "S√£o Paulo")
    data_hora = obter_data_hora(cidade_cliente)

    conta["extrato"].append({"tipo": "Saque", "valor": str(valor), "data_hora": data_hora})

    salvar_json("contas.json", contas)
    print(f"‚úÖ Sucesso: Saque de R$ {valor:.2f} realizado com sucesso na conta {conta_numero}!")
    print(f"‚ú® Seu novo saldo √© de R$ {novo_saldo:.2f}.")

# Visualizar extrato
def visualizar_extrato(conta_numero):
    """Exibe o hist√≥rico de transa√ß√µes (dep√≥sitos e saques) de um cliente autenticado."""
    print("\n--- üìÑ Extrato da Conta ---")
    contas = carregar_json("contas.json", {})

    if conta_numero not in contas:
        print("‚ö†Ô∏è Aten√ß√£o: A conta banc√°ria selecionada n√£o foi encontrada.")
        return

    conta = contas[conta_numero]
    extrato = conta.get("extrato", [])

    if not extrato:
        print(f"üîé N√£o h√° transa√ß√µes para exibir na conta {conta_numero} ainda.")
    else:
        print(f"üìä Hist√≥rico de Transa√ß√µes da Conta {conta_numero}:")
        print("--------------------------------------------------")
        for transacao in extrato:
            tipo = transacao.get("tipo", "Desconhecido")
            valor = transacao.get("valor", "N/A")
            data_hora = transacao.get("data_hora", "N/A")
            if tipo == "Dep√≥sito":
                 print(f"üü¢ {data_hora} | {tipo}: +R$ {Decimal(valor):.2f}")
            elif tipo == "Saque":
                 print(f"üî¥ {data_hora} | {tipo}: -R$ {Decimal(valor):.2f}")
            else:
                 print(f"‚ö´ {data_hora} | {tipo}: R$ {Decimal(valor):.2f}")
        print("--------------------------------------------------")

    saldo_decimal = Decimal(conta.get("saldo", "0"))
    print(f"‚ú® Saldo Atual da Conta {conta_numero}: R$ {saldo_decimal:.2f}")

# Menus
def exibir_menu_principal():
    """Exibe o menu de op√ß√µes antes da autentica√ß√£o."""
    print("\n===== Bem-vindo ao Banco do Pobre! =====")
    print("Escolha uma op√ß√£o abaixo:")
    print("1. üìù Cadastrar Novo Cliente")
    print("2. üîë J√° sou cliente! Autenticar")
    print("3. üö™ Sair do Sistema")
    print("==========================================")
    escolha = input("‚û°Ô∏è Digite o n√∫mero da sua escolha: ").strip()
    return escolha

def exibir_menu_conta(nome_cliente):
    """Exibe o menu de op√ß√µes ap√≥s a autentica√ß√£o e solicita a escolha do usu√°rio."""
    print(f"\n===== Ol√°, {nome_cliente}! Gerenciar Contas =====")
    print("Escolha uma op√ß√£o para gerenciar suas contas:")
    print("1. üí≥ Cadastrar Nova Conta Banc√°ria")
    print("2. üîë Acessar Conta Existente")
    print("6. ‚Ü©Ô∏è Voltar ao Menu Principal") # Moved to account menu
    print("==========================================")
    escolha = input("‚û°Ô∏è Digite o n√∫mero da sua escolha: ").strip()
    return escolha

# Menu para conta selecionada
def exibir_menu_operacoes_conta(conta_numero):
    """Exibe o menu de opera√ß√µes para uma conta selecionada."""
    print(f"\n===== Conta Selecionada: {conta_numero} =====")
    print("O que voc√™ gostaria de fazer?")
    print("1. üí∞ Realizar Dep√≥sito")
    print("2. üí∏ Realizar Saque")
    print("3. üìÑ Visualizar Extrato")
    print("4. ‚Ü©Ô∏è Voltar para Sele√ß√£o de Conta")
    print("==========================================")
    escolha = input("‚û°Ô∏è Digite o n√∫mero da op√ß√£o desejada: ").strip()
    return escolha


# L√≥gica de execu√ß√£o das op√ß√µes
def executar_opcao(escolha, cpf_autenticado, conta_selecionada):
    """Executa a fun√ß√£o correspondente √† op√ß√£o escolhida pelo usu√°rio."""
    if cpf_autenticado is None: # Pre-authentication options
        if escolha == "1":
            cadastrar_cliente()
        elif escolha == "2":
            cpf_autenticado = autenticar_cliente()
        elif escolha == "3": # Sair do Sistema from main menu
            print("üëã Saindo do sistema. Obrigado por usar nossos servi√ßos!")
            return None, None # Indicate exit by returning None for both
        else:
            print("‚ö†Ô∏è Op√ß√£o inv√°lida. Por favor, escolha uma op√ß√£o v√°lida do menu principal (1-3).")
    else: # Post-authentication options
        if conta_selecionada is None: # User is authenticated but no account is selected
            if escolha == "1": # Cadastrar Nova Conta Banc√°ria
                cadastrar_conta(cpf_autenticado)
            elif escolha == "2": # Acessar Conta Existente
                conta_selecionada = selecionar_conta(cpf_autenticado)
            elif escolha == "6": # Voltar ao Menu Principal (from account management menu)
                print("‚Ü©Ô∏è Voltando ao Menu Principal.")
                cpf_autenticado = None # Reset authentication
                conta_selecionada = None # Also reset selected account
            else:
                 print("‚ö†Ô∏è Por favor, selecione ou cadastre uma conta antes de realizar opera√ß√µes (Op√ß√µes 1 ou 2).")
        else: # User is authenticated and an account is selected (Operations menu)
            if escolha == "1": # Dep√≥sito
                depositar(conta_selecionada)
            elif escolha == "2": # Saque
                sacar(conta_selecionada)
            elif escolha == "3": # Extrato
                visualizar_extrato(conta_selecionada)
            elif escolha == "4": # Voltar para Sele√ß√£o de Conta
                print("‚Ü©Ô∏è Voltando para a sele√ß√£o de contas.")
                conta_selecionada = None # Reset selected account
            else:
                print(f"‚ö†Ô∏è Op√ß√£o inv√°lida. Por favor, escolha uma op√ß√£o v√°lida do menu de opera√ß√µes da conta (1-4).")


    return cpf_autenticado, conta_selecionada # Return the updated authentication and selected account status

# Main loop
cpf_autenticado = None
conta_selecionada = None

while True:
    if cpf_autenticado is None:
        opcao = exibir_menu_principal()
        if opcao == "3":
             cpf_autenticado, conta_selecionada = executar_opcao(opcao, cpf_autenticado, conta_selecionada)
             break
        cpf_autenticado, conta_selecionada = executar_opcao(opcao, cpf_autenticado, conta_selecionada)
    else:
        clientes = carregar_json("clientes.json", {})
        nome_cliente = clientes.get(cpf_autenticado, {}).get("nome", "Cliente")
        if conta_selecionada is None:
             opcao = exibir_menu_conta(nome_cliente)
             cpf_autenticado, conta_selecionada = executar_opcao(opcao, cpf_autenticado, conta_selecionada)
        else:
             opcao = exibir_menu_operacoes_conta(conta_selecionada) # Use the new operations menu
             cpf_autenticado, conta_selecionada = executar_opcao(opcao, cpf_autenticado, conta_selecionada)
